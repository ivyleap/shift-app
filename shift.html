<!-- head 内で読み込み -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdn.tailwindcss.com?plugins=forms"></script>

<body class="p-4 bg-gray-100">
  <h1 class="text-2xl font-bold mb-4">シフトカレンダー</h1>

  <!-- ① カレンダー表示エリア -->
  <div id="calendar"></div>

  <!-- ② シフト入力モーダル -->
  <div id="shiftModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center">
    <div class="bg-white rounded-xl p-6 w-80">
      <h2 class="text-lg font-semibold mb-3">シフトを登録</h2>

      <label class="block text-sm">開始</label>
      <input id="startTime" type="time" value="09:00" class="form-input w-full mb-2">

      <label class="block text-sm">終了</label>
      <input id="endTime" type="time" value="18:00" class="form-input w-full mb-2">

      <label class="block text-sm">ステータス</label>
      <select id="status" class="form-select w-full mb-4">
        <option value="出勤">出勤</option>
        <option value="有給">有給</option>
        <option value="欠勤">欠勤</option>
        <option value="遅刻">遅刻</option>
      </select>

      <!-- ③ 複数日コピー対応 -->
      <p class="text-xs mb-1">適用する日付をカレンダーで複数選択してください</p>
      <button id="saveShift" class="bg-blue-600 text-white w-full py-2 rounded">保存</button>
    </div>
  </div>

  <script>
    // フルカレンダー初期化
    const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
      locale: 'ja',
      height: 'auto',
      selectable: true,         // ← 選択範囲を取得
      selectMirror: true,
      select (info) {           // 日付をドラッグ or クリックで選択
        selectedRange = info;   // グローバル格納
        openModal();
      },
      events: loadEvents(),     // 既存シフト読み込み
      eventContent(arg) {       // 表示を “9-18｜出勤” 形式に
        return { html: `<b>${arg.event.title}</b>` };
      }
    });
    calendar.render();

    // モーダル制御
    function openModal() { document.getElementById('shiftModal').classList.remove('hidden'); }
    function closeModal() { document.getElementById('shiftModal').classList.add('hidden'); }

    // 保存ボタン
    document.getElementById('saveShift').onclick = () => {
      // 取得値
      const s = document.getElementById('startTime').value;
      const e = document.getElementById('endTime').value;
      const st = document.getElementById('status').value;
      const title = `${s}-${e}｜${st}`;

      // 選択範囲の日付へ一括追加
      let cur = new Date(selectedRange.start);
      while (cur <= selectedRange.end) {
        const dateStr = cur.toISOString().split('T')[0];
        calendar.addEvent({ title, start: dateStr, allDay: true, extendedProps:{ s, e, st } });
        cur.setDate(cur.getDate() + 1);
      }
      closeModal();
      saveToStorage();   // ←ローカル保存 or Sheets 送信
    };

    /* ------------ ストレージ部は後で改良可能 --------------- */
    function loadEvents() {
      const raw = localStorage.getItem('shift_events') || '[]';
      return JSON.parse(raw);
    }
    function saveToStorage() {
      const events = calendar.getEvents().map(ev => ({
        title: ev.title,
        date:  ev.startStr,
        s: ev.extendedProps.s,
        e: ev.extendedProps.e,
        st: ev.extendedProps.st
      }));
      localStorage.setItem('shift_events', JSON.stringify(events));
    }
    /* ------------------------------------------------------- */
  </script>
</body>
