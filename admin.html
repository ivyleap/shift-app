<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>管理者ビュー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
</head>
<body class="p-4 bg-gray-100">
  <h1 class="text-2xl font-bold mb-4">全スタッフシフト一覧（ローカル保存データ）</h1>

  <div id="container" class="space-y-10"></div>

  <!-- CSV ダウンロード -->
  <div class="mt-8">
    <button onclick="downloadCSV()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
      CSVダウンロード
    </button>
  </div>

<script>
/* ====== 設定 ====== */
const staff  = ["須藤","渡辺","小林","鹿田","木村","撫"];
const header = ["日付","開始","終了","休憩","稼働時間","区分"];

/* ====== ユーティリティ ====== */
function load(u){ return JSON.parse(localStorage.getItem('shifts_'+u)||'[]'); }

/* ====== テーブル作成（月別） ====== */
function buildMonthTable(data){
  let rows = data.map(e=>`
    <tr class="border-b">
      <td class="p-2">${e.date}</td>
      <td class="p-2">${e.start}</td>
      <td class="p-2">${e.end}</td>
      <td class="p-2">1h</td>
      <td class="p-2">${e.hours}h</td>
      <td class="p-2">${e.status}</td>
    </tr>`).join("");

  return `
    <table class="min-w-full text-sm border mb-6">
      <thead class="bg-gray-50">
        <tr>${header.map(h=>`<th class="p-2">${h}</th>`).join("")}</tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>`;
}

/* ====== スタッフごとに描画 ====== */
function buildStaffBlock(user,data){
  if(!data.length) return `<h2 class="text-xl font-semibold">${user}</h2><p class="mb-6 text-gray-400">データなし</p>`;

  // 月別にグループ化
  const byMonth = {};
  data.forEach(e=>{
    const m = e.date.slice(0,7);   // "YYYY-MM"
    (byMonth[m] = byMonth[m] || []).push(e);
  });

  // 月ソート（新→旧）
  const months = Object.keys(byMonth).sort((a,b)=>b.localeCompare(a));

  let html = `<h2 class="text-xl font-semibold mb-2">${user}</h2>`;
  months.forEach(m=>{
    html += `<h3 class="font-bold mb-1">${m}</h3>`;
    html += buildMonthTable(byMonth[m]);
  });
  return html;
}

/* ====== CSV ダウンロード ====== */
function downloadCSV(){
  const rows=[["スタッフ",...header]];
  staff.forEach(u=>load(u).forEach(e=>{
    rows.push([u,e.date,e.start,e.end,"1h",e.hours,e.status]);
  }));
  const csv=rows.map(r=>r.join(",")).join("\\n");
  const blob=new Blob([csv],{type:"text/csv"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="shift_data.csv"; a.click();
  URL.revokeObjectURL(url);
}

/* ====== 初期描画 ====== */
(function(){
  const container=document.getElementById("container");
  staff.forEach(u=>{
    const html=buildStaffBlock(u, load(u));
    container.insertAdjacentHTML("beforeend",html);
  });
})();
</script>
</body>
</html>
